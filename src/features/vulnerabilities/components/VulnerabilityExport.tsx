import {
  IconButton,
  Menu,
  Portal,
} from '@chakra-ui/react'
import { FiDownload } from 'react-icons/fi'
import { Table } from '@tanstack/react-table'
import { FlattenedVulnerability } from '../../types'

interface Props {
  table: Table<FlattenedVulnerability>
  data: FlattenedVulnerability[]
}

const VulnerabilitiesExport = ({ table }: Props) => {
  const handleExportJson = () => {
    const blob = new Blob(
      [JSON.stringify(table.getFilteredRowModel().rows.map(r => r.original), null, 2)],
      { type: 'application/json' }
    )
    const url = URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = 'vulnerabilities.json'
    link.click()
    URL.revokeObjectURL(url)
  }

  const handleExportCsv = () => {
    const rows = table.getFilteredRowModel().rows.map(r => r.original)
    if (rows.length === 0) return

    const headers = Object.keys(rows[0])
    const csv = [
      headers.join(','),
      ...rows.map(row =>
        headers.map(h => JSON.stringify(row[h as keyof typeof row] ?? '')).join(',')
      ),
    ].join('\n')

    const blob = new Blob([csv], { type: 'text/csv' })
    const url = URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = 'vulnerabilities.csv'
    link.click()
    URL.revokeObjectURL(url)
  }

  return (
    <Menu.Root>
      <Menu.Trigger>
        <IconButton
          aria-label="Export"
          size="sm"
          variant="outline"
          style={{padding: "8px"}}
        >
          Export Table
          <FiDownload />
        </IconButton>
      </Menu.Trigger>
      <Portal>
        <Menu.Positioner>
          <Menu.Content>
            <Menu.Item value="json" onClick={handleExportJson}>
              Export as JSON
            </Menu.Item>
            <Menu.Item value="csv" onClick={handleExportCsv}>
              Export as CSV
            </Menu.Item>
          </Menu.Content>
        </Menu.Positioner>
      </Portal>
    </Menu.Root>
  )
}

export default VulnerabilitiesExport